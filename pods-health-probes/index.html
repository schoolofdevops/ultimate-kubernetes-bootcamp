<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Adding health checks with Probes - Ultimate Kubernetes Bootcamp</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Adding health checks with Probes";
    var mkdocs_page_input_path = "pods-health-probes.md";
    var mkdocs_page_url = "/pods-health-probes/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Ultimate Kubernetes Bootcamp</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Setup</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../minikube/">Using minikube to setup single node environment</a>
                </li>
                <li class="">
                    
    <a class="" href="../2_kube_cluster_vagrant/">Provisioning VMs with Vagrant</a>
                </li>
                <li class="">
                    
    <a class="" href="../3_install_kubernetes/">Setup Kubernetes Cluster</a>
                </li>
                <li class="">
                    
    <a class="" href="../kube_visualizer/">Kuberentes Visualizer</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Kubernetes Fundamentals</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../5-vote-deploying_pods/">Launching Pods</a>
                </li>
                <li class="">
                    
    <a class="" href="../replication/">Making application highly available</a>
                </li>
                <li class="">
                    
    <a class="" href="../7-vote-exposing_app_with_service/">Publishing appliaction and Service Discovery</a>
                </li>
                <li class="">
                    
    <a class="" href="../6-vote-kubernetes_deployment/">Defining Update Strategy</a>
                </li>
                <li class="">
                    
    <a class="" href="../9-vote-configmaps_and_secrets/">Managing Configurations and Secrets</a>
                </li>
                <li class="">
                    
    <a class="" href="../vote-persistent-volumes/">Making Data Persist</a>
                </li>
                <li class="">
                    
    <a class="" href="../11_deploying_sample_app/">Mini Project</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Advanced Kubernetes</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../kubespray-prereqs/">Kubespray lab setup with Vagrant</a>
                </li>
                <li class="">
                    
    <a class="" href="../cluster_setup_kubespray/">Production grade setup with Kubespray</a>
                </li>
                <li class="">
                    
    <a class="" href="../configuring_authentication_and_authorization/">Authentication and Authorization (RBAC)</a>
                </li>
                <li class="">
                    
    <a class="" href="../advanced_pod_scheduling/">Advanced Pod Scheduling</a>
                </li>
                <li class="">
                    
    <a class="" href="../pod-adv-specs/">Pod Resource and Security Specs</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Adding health checks with Probes</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#checking-health-with-probes">Checking health with Probes</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#adding-health-checks">Adding health checks</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../ingress/">Application Routing with Ingress Controllers</a>
                </li>
                <li class="">
                    
    <a class="" href="../10_kubernetes_autoscaling/">Auto Scaling Capacity with HPA</a>
                </li>
                <li class="">
                    
    <a class="" href="../13_redis_statefulset/">Creating Replicated Redis Cluster with Statefulsets</a>
                </li>
                <li class="">
                    
    <a class="" href="../network_policies/">Access Control with Network Policies</a>
                </li>
                <li class="">
                    
    <a class="" href="../cluster-administration/">Cluster Administration</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Additional Topics</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../vote-deployement_strategies/">Building Deployment Strategies</a>
                </li>
                <li class="">
                    
    <a class="" href="../12_troubleshooting/">Troubleshooting Tips</a>
                </li>
                <li class="">
                    
    <a class="" href="../logging/">Logging</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">References</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../rbac-resource-group-mapping/">RBAC apiGroups to Resource Mapping</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Ultimate Kubernetes Bootcamp</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Advanced Kubernetes &raquo;</li>
        
      
    
    <li>Adding health checks with Probes</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="checking-health-with-probes">Checking health with Probes</h1>
<h2 id="adding-health-checks">Adding health checks</h2>
<p>Health checks in Kubernetes work the same way as traditional health checks of applications. They make sure that our application is ready to receive and process user requests. In Kubernetes we have two types of health checks,
  * Liveness Probe
  * Readiness Probe
Probes are simply a <em>diagnostic action</em> performed by the kubelet. There are three types actions a kubelet perfomes on a pod, which are namely,
  * <code>ExecAction</code>: Executes a command inside the pod. Assumed successful when the command <strong>returns 0</strong> as exit code.
  * <code>TCPSocketAction</code>: Checks for a state of a particular port on the pod. Considered successful when the state of <strong>the port is open</strong>.
  * <code>HTTPGetAction</code>: Performs a GET request on pod's IP. Assumed successful when the status code is <strong>greater than 200 and less than 400</strong></p>
<p>In cases of any failure during the diagnostic action, kubelet will report back to the API server. Let us study about how these health checks work in practice.</p>
<h3 id="liveness-probe">Liveness Probe</h3>
<p>Liveness probe checks the status of the pod(whether it is running or not). If livenessProbe fails, then the pod is subjected to its restart policy. The default state of livenessProbe is <em>Success</em>.</p>
<p>Let us add liveness probe to our <em>frontend</em> deployment. The following probe will check whether it is able to <em>access the port or not</em>.</p>
<p><code>File: code/frontend-deploy.yml</code></p>
<pre><code>apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: front-end
  namespace: instavote
  labels:
    app: front-end
    env: dev
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: front-end
        env: dev
    spec:
      containers:
        - name: front-end
          image: schoolofdevops/frontend
          imagePullPolicy: Always
          ports:
            - containerPort: 8079
          livenessProbe:
            tcpSocket:
              port: 8079
            initialDelaySeconds: 5
            periodSeconds: 5
</code></pre>

<p><code>Expected output:</code></p>
<pre><code>kubectl apply -f front-end/frontend-deploy.yml
kubectl get pods
kubectl describe pod front-end-757db58546-fkgdw

[...]
Events:
  Type    Reason                 Age   From               Message
  ----    ------                 ----  ----               -------
  Normal  Scheduled              22s   default-scheduler  Successfully assigned front-end-757db58546-fkgdw to node4
  Normal  SuccessfulMountVolume  22s   kubelet, node4     MountVolume.SetUp succeeded for volume &quot;default-token-w4279&quot;
  Normal  Pulling                20s   kubelet, node4     pulling image &quot;schoolofdevops/frontend&quot;
  Normal  Pulled                 17s   kubelet, node4     Successfully pulled image &quot;schoolofdevops/frontend&quot;
  Normal  Created                17s   kubelet, node4     Created container
  Normal  Started                17s   kubelet, node4     Started container
</code></pre>

<p>Let us change the livenessProbe check port to 8080.</p>
<pre><code>          livenessProbe:
            tcpSocket:
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5
</code></pre>

<p>Apply this deployment file and check the description of the pod</p>
<p><code>Expected output:</code></p>
<pre><code>kubectl apply -f frontend-deploy.yml
kubectl get pods
kubectl describe pod front-end-bf86ffd8b-bjb7p

[...]
Events:
  Type     Reason                 Age               From               Message
  ----     ------                 ----              ----               -------
  Normal   Scheduled              1m                default-scheduler  Successfully assigned front-end-bf86ffd8b-bjb7p to node3
  Normal   SuccessfulMountVolume  1m                kubelet, node3     MountVolume.SetUp succeeded for volume &quot;default-token-w4279&quot;
  Normal   Pulling                38s (x2 over 1m)  kubelet, node3     pulling image &quot;schoolofdevops/frontend&quot;
  Normal   Killing                38s               kubelet, node3     Killing container with id docker://front-end:Container failed liveness probe.. Container will be killed and recreated.
  Normal   Pulled                 35s (x2 over 1m)  kubelet, node3     Successfully pulled image &quot;schoolofdevops/frontend&quot;
  Normal   Created                35s (x2 over 1m)  kubelet, node3     Created container
  Normal   Started                35s (x2 over 1m)  kubelet, node3     Started container
  Warning  Unhealthy              27s (x5 over 1m)  kubelet, node3     Liveness probe failed: Get http://10.233.71.50:8080/: dial tcp 10.233.71.50:8080: getsockopt: connection refused
</code></pre>

<h3 id="readiness-probe">Readiness Probe</h3>
<p>Readiness probe checks whether your application is ready to serve the requests. When the readiness probe fails, the pod's IP is removed from the end point list of the service. The default state of readinessProbe is <em>Success</em>.</p>
<p>Readiness probe is configured just like liveness probe. But this time we will use <em>httpGet request</em>.</p>
<p><code>File: code/frontend-deploy.yml</code></p>
<pre><code>apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: front-end
  namespace: instavote
  labels:
    app: front-end
    env: dev
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: front-end
        env: dev
    spec:
      containers:
        - name: front-end
          image: schoolofdevops/frontend
          imagePullPolicy: Always
          ports:
            - containerPort: 8079
          livenessProbe:
            tcpSocket:
              port: 8079
            initialDelaySeconds: 5
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /
              port: 8079
            initialDelaySeconds: 5
            periodSeconds: 3
</code></pre>

<p><code>Expected output:</code></p>
<pre><code>kubectl apply -f front-end/frontend-deploy.yml
kubectl get pods
kubectl describe pod front-end-c5bc89b57-g42nc

[...]
Events:
  Type    Reason                 Age   From               Message
  ----    ------                 ----  ----               -------
  Normal  Scheduled              11s   default-scheduler  Successfully assigned front-end-c5bc89b57-g42nc to node4
  Normal  SuccessfulMountVolume  10s   kubelet, node4     MountVolume.SetUp succeeded for volume &quot;default-token-w4279&quot;
  Normal  Pulling                8s    kubelet, node4     pulling image &quot;schoolofdevops/frontend&quot;
  Normal  Pulled                 6s    kubelet, node4     Successfully pulled image &quot;schoolofdevops/frontend&quot;
  Normal  Created                5s    kubelet, node4     Created container
  Normal  Started                5s    kubelet, node4     Started container
</code></pre>

<p><strong>Task</strong>: Change the readinessProbe port to 8080 and check what happens to the pod.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../ingress/" class="btn btn-neutral float-right" title="Application Routing with Ingress Controllers">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../pod-adv-specs/" class="btn btn-neutral" title="Pod Resource and Security Specs"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../pod-adv-specs/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../ingress/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
      <script src="../search/require.js"></script>
      <script src="../search/search.js"></script>

</body>
</html>
