<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Making application highly available - Ultimate Kubernetes Bootcamp</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Making application highly available";
    var mkdocs_page_input_path = "replication.md";
    var mkdocs_page_url = "/replication/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Ultimate Kubernetes Bootcamp</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Setup</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../minikube/">Using minikube to setup single node environment</a>
                </li>
                <li class="">
                    
    <a class="" href="../2_kube_cluster_vagrant/">Provisioning VMs with Vagrant</a>
                </li>
                <li class="">
                    
    <a class="" href="../3_install_kubernetes/">Setup Kubernetes Cluster</a>
                </li>
                <li class="">
                    
    <a class="" href="../kube_visualizer/">Kuberentes Visualizer</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Kubernetes Fundamentals</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../5-vote-deploying_pods/">Launching Pods</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Making application highly available</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#making-application-high-available-with-replication-controllers">Making application high available with Replication Controllers</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#setting-up-a-namespace">Setting up a Namespace</a></li>
        
            <li><a class="toctree-l4" href="#creating-a-namespace">Creating a namespace</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../7-vote-exposing_app_with_service/">Publishing appliaction and Service Discovery</a>
                </li>
                <li class="">
                    
    <a class="" href="../6-vote-kubernetes_deployment/">Defining Update Strategy</a>
                </li>
                <li class="">
                    
    <a class="" href="../11_deploying_sample_app/">Mini Project</a>
                </li>
                <li class="">
                    
    <a class="" href="../9-vote-configmaps_and_secrets/">Managing Configurations and Secrets</a>
                </li>
                <li class="">
                    
    <a class="" href="../vote-persistent-volumes/">Making Data Persist</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Advanced Kubernetes</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../kubespray-prereqs/">Kubespray lab setup with Vagrant</a>
                </li>
                <li class="">
                    
    <a class="" href="../cluster_setup_kubespray/">HA setup with Kubespray</a>
                </li>
                <li class="">
                    
    <a class="" href="../configuring_authentication_and_authorization/">Authentication and Authorization (RBAC)</a>
                </li>
                <li class="">
                    
    <a class="" href="../advanced_pod_scheduling/">Advanced Pod Scheduling</a>
                </li>
                <li class="">
                    
    <a class="" href="../pod-adv-specs/">Pod Resource and Security Specs</a>
                </li>
                <li class="">
                    
    <a class="" href="../pods-health-probes/">Adding health checks with Probes</a>
                </li>
                <li class="">
                    
    <a class="" href="../ingress/">Application Routing with Ingress Controllers</a>
                </li>
                <li class="">
                    
    <a class="" href="../10_kubernetes_autoscaling/">Auto Scaling Capacity with HPA</a>
                </li>
                <li class="">
                    
    <a class="" href="../13_redis_statefulset/">Creating Replicated Redis Cluster with Statefulsets</a>
                </li>
                <li class="">
                    
    <a class="" href="../network_policies/">Access Control with Network Policies</a>
                </li>
                <li class="">
                    
    <a class="" href="../cluster-administration/">Cluster Administration</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Additional Topics</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../vote-deployement_strategies/">Building Deployment Strategies</a>
                </li>
                <li class="">
                    
    <a class="" href="../12_troubleshooting/">Troubleshooting Tips</a>
                </li>
                <li class="">
                    
    <a class="" href="../logging/">Logging</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">References</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../rbac-resource-group-mapping/">RBAC apiGroups to Resource Mapping</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Ultimate Kubernetes Bootcamp</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Kubernetes Fundamentals &raquo;</li>
        
      
    
    <li>Making application highly available</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="making-application-high-available-with-replication-controllers">Making application high available with Replication Controllers</h1>
<p>If you are not running a monitoring screen, start it in a new terminal with the following command.</p>
<pre><code>watch -n 1 kubectl get  pod,deploy,rs,svc
</code></pre>

<pre><code>kubectl delete pod vote
</code></pre>

<h3 id="setting-up-a-namespace">Setting up a Namespace</h3>
<p>Check current config</p>
<pre><code>
kubectl config view
</code></pre>

<p>You could also examine the current configs in file <strong>cat ~/.kube/config</strong></p>
<h2 id="creating-a-namespace">Creating a namespace</h2>
<p>Namespaces offers separation of resources running on the same physical infrastructure into virtual clusters. It is typically useful in mid to large scale environments with multiple projects, teams and need separate scopes. It could also be useful to map to your workflow stages e.g. dev, stage, prod.   </p>
<p>Lets create a namespace called <strong>instavote</strong>  </p>
<pre><code>cd projects/instavote
cat instavote-ns.yaml
</code></pre>

<p>[output]</p>
<pre><code>kind: Namespace
apiVersion: v1
metadata:
  name: instavote
</code></pre>

<p>Lets create a namespace</p>
<pre><code>kubectl get ns
kubectl apply -f instavote-ns.yaml

kubectl get ns
</code></pre>

<p>And switch to it</p>
<pre><code>kubectl config --help

kubectl config get-contexts

kubectl config current-context

kubectl config set-context $(kubectl config current-context) --namespace=instavote

kubectl config view

kubectl config get-contexts

</code></pre>

<p><strong>Exercise</strong>: Go back to the monitoring screen and observe what happens after switching the namespace.</p>
<p>To understand how ReplicaSets works with the selectors  lets launch a pod in the new namespace with existing specs.</p>
<pre><code>cd k8s-code/pods
kubectl apply -f vote-pod.yaml

kubectl get pods
cd ../projects/instavote/dev/
</code></pre>

<p>Lets now write the spec for the Rplica Set. This is going to mainly contain,</p>
<ul>
<li>replicas</li>
<li>selector</li>
<li>template (pod spec )</li>
<li>minReadySeconds</li>
</ul>
<p><em>file: vote-rs.yaml</em></p>
<pre><code>apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: vote
spec:
  replicas: 5
  minReadySeconds: 20
  selector:
    matchLabels:
      role: vote
    matchExpressions:
      - {key: version, operator: In, values: [v1, v2, v3]}
  template:
</code></pre>

<p>Lets now add the metadata and spec from pod spec defined in vote-pod.yaml. And with that, the Replica Set Spec changes to</p>
<p><em>file: vote-rs.yaml</em></p>
<pre><code>apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: vote
spec:
  replicas: 5
  minReadySeconds: 20
  selector:
    matchLabels:
      role: vote
    matchExpressions:
      - {key: version, operator: In, values: [v1, v2, v3]}
  template:
    metadata:
      name: vote
      labels:
        app: python
        role: vote
        version: v1
    spec:
      containers:
        - name: app
          image: schoolofdevops/vote:v1
          ports:
            - containerPort: 80
              protocol: TCP

</code></pre>

<h3 id="replica-sets-in-action">Replica Sets in Action</h3>
<pre><code>kubectl apply -f vote-rs.yaml --dry-run

kubectl apply -f vote-rs.yaml

kubectl get rs

kubectl describe rs vote

kubectl get pods


</code></pre>

<p><strong>Exercise</strong> :  </p>
<ul>
<li>Switch to monitoring screen, observe how many replicas were created  and why</li>
<li>Compare selectors and labels of the pods created with and without replica sets</li>
</ul>
<pre><code>kubectl get pods

kubectl get pods --show-labels
</code></pre>

<h3 id="exercise-deploying-new-version-of-the-application">Exercise: Deploying new version of the application</h3>
<pre><code>kubectl edit rs/vote
</code></pre>

<p>Update the version of the image from <strong>schoolofdevops/vote:v1</strong> to <strong>schoolofdevops/vote:v2</strong></p>
<p>Save the file. Observe if application got updated. Note what do you observe. Do you see the new version deployed ??</p>
<h3 id="exercise-self-healing-replica-sets">Exercise: Self Healing Replica Sets</h3>
<p>List the pods and kill some of those, see what replica set does.</p>
<pre><code>kubectl get pods
kubectl delete pods  vote-xxxx  vote-yyyy
</code></pre>

<p>where replace xxxx and yyyy with actual pod ids.</p>
<p>Questions:</p>
<ul>
<li>Did replica set replaced the pods ?</li>
<li>Which version of the application is running now ?</li>
</ul>
<p>Lets now delete the pod created independent of replica set.</p>
<pre><code>kubectl get pods
kubectl delete pods  vote
</code></pre>

<p>Observe what happens.
  * Does replica set take any action after deleting the pod created outside of its spec ? Why?</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../7-vote-exposing_app_with_service/" class="btn btn-neutral float-right" title="Publishing appliaction and Service Discovery">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../5-vote-deploying_pods/" class="btn btn-neutral" title="Launching Pods"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../5-vote-deploying_pods/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../7-vote-exposing_app_with_service/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
      <script src="../search/require.js"></script>
      <script src="../search/search.js"></script>

</body>
</html>
