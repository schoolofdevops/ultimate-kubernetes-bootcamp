<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Access Control with Network Policies - Ultimate Kubernetes Bootcamp</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Access Control with Network Policies";
    var mkdocs_page_input_path = "network_policies.md";
    var mkdocs_page_url = "/network_policies/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Ultimate Kubernetes Bootcamp</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Setup</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../minikube/">Using minikube to setup single node environment</a>
                </li>
                <li class="">
                    
    <a class="" href="../2_kube_cluster_vagrant/">Provisioning VMs with Vagrant</a>
                </li>
                <li class="">
                    
    <a class="" href="../3_install_kubernetes/">Setup Kubernetes Cluster</a>
                </li>
                <li class="">
                    
    <a class="" href="../kube_visualizer/">Kuberentes Visualizer</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Kubernetes Fundamentals</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../5-vote-deploying_pods/">Launching Pods</a>
                </li>
                <li class="">
                    
    <a class="" href="../replication/">Making application highly available</a>
                </li>
                <li class="">
                    
    <a class="" href="../7-vote-exposing_app_with_service/">Publishing appliaction and Service Discovery</a>
                </li>
                <li class="">
                    
    <a class="" href="../6-vote-kubernetes_deployment/">Defining Update Strategy</a>
                </li>
                <li class="">
                    
    <a class="" href="../9-vote-configmaps_and_secrets/">Managing Configurations and Secrets</a>
                </li>
                <li class="">
                    
    <a class="" href="../vote-persistent-volumes/">Making Data Persist</a>
                </li>
                <li class="">
                    
    <a class="" href="../11_deploying_sample_app/">Mini Project</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Advanced Kubernetes</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../kubespray-prereqs/">Kubespray lab setup with Vagrant</a>
                </li>
                <li class="">
                    
    <a class="" href="../cluster_setup_kubespray/">Production grade setup with Kubespray</a>
                </li>
                <li class="">
                    
    <a class="" href="../configuring_authentication_and_authorization/">Authentication and Authorization (RBAC)</a>
                </li>
                <li class="">
                    
    <a class="" href="../advanced_pod_scheduling/">Advanced Pod Scheduling</a>
                </li>
                <li class="">
                    
    <a class="" href="../pods-health-probes/">Adding health checks with Probes</a>
                </li>
                <li class="">
                    
    <a class="" href="../vote-deployement_strategies/">Building Deployment Strategies</a>
                </li>
                <li class="">
                    
    <a class="" href="../10_kubernetes_autoscaling/">Auto Scaling Capacity with HPA</a>
                </li>
                <li class="">
                    
    <a class="" href="../ingress/">Application Routing with Ingress Controllers</a>
                </li>
                <li class="">
                    
    <a class="" href="../13_redis_statefulset/">Creating Replicated Cluster Setup for Redis</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Access Control with Network Policies</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#setting-up-a-firewall-with-network-policies">Setting up a firewall with Network Policies</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#setting-up-ingress-rules-for-outward-facing-applications">Setting up ingress rules for outward facing applications</a></li>
        
            <li><a class="toctree-l4" href="#setting-up-egress-rules-to-allow-communication-between-services-from-same-project">Setting up egress rules to allow communication between services from same project</a></li>
        
            <li><a class="toctree-l4" href="#project">Project</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../ingress/">Ingress Controllers</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Additional Topics</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../12_troubleshooting/">Troubleshooting Tips</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">References</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../rbac-resource-group-mapping/">RBAC apiGroups to Resource Mapping</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Ultimate Kubernetes Bootcamp</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Advanced Kubernetes &raquo;</li>
        
      
    
    <li>Access Control with Network Policies</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="setting-up-a-firewall-with-network-policies">Setting up a firewall with Network Policies</h1>
<p>While setting up the network policy, you may need to refer to the namespace created earlier. In order to being abel to referred to, namespace should have a label. Lets  update the namespace with a label.</p>
<p><code>file: instavote-ns.yaml</code></p>
<pre><code>kind: Namespace
apiVersion: v1
metadata:
  name: instavote
  labels:
    project: instavote

</code></pre>

<p>apply</p>
<pre><code>kubectl get namespace --show-labels
kubectl apply -f instavote-ns.yaml
kubectl get namespace --show-labels

</code></pre>

<p>Now, define a restrictive network policy which would,</p>
<ul>
<li>Block all incoming connections from any source except for pods from the same namespace  </li>
<li>Block all outgoing connections</li>
</ul>
<pre><code class="bash">
  +-----------------------------------------------------------+
  |                                                           |
  |    +----------+          +-----------+                    |
x |    | results  |          | db        |                    |
  |    |          |          |           |                    |
  |    +----------+          +-----------+                    |
  |                                                           |
  |                                                           |
  |                                        +----+----+--+     |           
  |                                        |   worker   |     |            
  |                                        |            |     |           
  |                                        +----+-------+     |           
  |                                                           |
  |                                                           |
  |    +----------+          +-----------+                    |
  |    | vote     |          | redis     |                    |
x |    |          |          |           |                    |
  |    +----------+          +-----------+                    |
  |                                                           |
  +-----------------------------------------------------------+

</code></pre>

<p>file: <code>instavote-netpol.yaml</code></p>
<pre><code>apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
</code></pre>

<p>apply</p>
<pre><code>kubectl get netpol

kubectl apply -f instavote-netpol.yaml

kubectl get netpol

kubectl describe netpol/default-deny

</code></pre>

<p>Try accessing the vote and results ui. Can you access it ?</p>
<h4 id="setting-up-ingress-rules-for-outward-facing-applications">Setting up ingress rules for outward facing applications</h4>
<pre><code class="bash">
  +-----------------------------------------------------------+
  |                                                           |
  |    +----------+          +-----------+                    |
=====&gt; | results  |          | db        |                    |
  |    |          |          |           |                    |
  |    +----------+          +-----------+                    |
  |                                                           |
  |                                                           |
  |                                        +----+----+--+     |           
  |                                        |   worker   |     |            
  |                                        |            |     |           
  |                                        +----+-------+     |           
  |                                                           |
  |                                                           |
  |    +----------+          +-----------+                    |
  |    | vote     |          | redis     |                    |
=====&gt; |          |          |           |                    |
  |    +----------+          +-----------+                    |
  |                                                           |
  +-----------------------------------------------------------+

</code></pre>

<p>To the same file, add a new network policy object.</p>
<p><code>file: instavote-netpol.yaml</code></p>
<pre><code>apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: public-ingress
  namespace: instavote
spec:
  podSelector:
    matchExpressions:
      - {key: role, operator: In, values: [vote, results]}
  policyTypes:
  - Ingress
  ingress:
    - {}
</code></pre>

<p>where,</p>
<p><em>instavote-ingress</em> is a new network policy  which,</p>
<ul>
<li>defines policy for pods with <strong>vote</strong> and <strong>results</strong> role</li>
<li>and allows them incoming access from anywhere</li>
</ul>
<p>apply</p>
<pre><code>kubectl apply -f instavote-netpol.yaml
</code></pre>

<p><strong>Exercise</strong></p>
<ul>
<li>Try accessing the ui now and check if you are able to.</li>
<li>Try to vote, see if that works? Why ?</li>
</ul>
<h4 id="setting-up-egress-rules-to-allow-communication-between-services-from-same-project">Setting up egress rules to allow communication between services from same project</h4>
<p>When you tried to vote, you might have observed that it does not work. Thats because the default network policy we created earlier blocks all outgoing traffic. Which is good for securing the  environment, however you still need to provide inter connection between services from the same project.  Specifically <strong>vote</strong>, <strong>worker</strong> and <strong>results</strong> apps need outgoing connection to <strong>redis</strong> and <strong>db</strong>. Lets allow that with a egress policy.</p>
<pre><code class="bash">
  +-----------------------------------------------------------+
  |                                                           |
  |    +------------+        +-----------+                    |
=====&gt; | results    | ------&gt;| db        |                    |
  |    |            |        |           | &lt;-------+          |
  |    +------------+        +-----------+         |          |
  |                                                |          |
  |                                                |          |
  |                                        +----+----+---+    |           
  |                                        |   worker    |    |            
  |                                        |             |    |           
  |                                        +----+--------+    |           
  |                                                |          |
  |                                                |          |
  |    +----------+          +-----------+         |          |
  |    | vote     |          | redis     | &lt;-------+          |
=====&gt; |          |  ------&gt; |           |                    |
  |    +----------+          +-----------+                    |
  |                                                           |
  +-----------------------------------------------------------+

</code></pre>

<p>Edit the same policy file  and add the following snippet,</p>
<p><code>file: instavote-netpol.yaml</code></p>
<pre><code>apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          project: instavote
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          project: instavote
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: public-ingress
  namespace: instavote
spec:
  podSelector:
    matchExpressions:
      - {key: role, operator: In, values: [vote, results]}
  policyTypes:
  - Ingress
  ingress:
    - {}
</code></pre>

<p>where,</p>
<p><em>instavote-egress</em> is a new network policy  which,</p>
<ul>
<li>defines policy for pods with <strong>vote</strong>, <strong>worker</strong> and <strong>results</strong> role</li>
<li>and allows them outgoing  access to  any pods in the same namespace, and that includes <strong>redis</strong> and <strong>db</strong></li>
</ul>
<h3 id="project">Project</h3>
<p>The above network policies are a good start. However you could even further restrict access by creating a granular network policy for each application.  </p>
<p>Create network policies with following specs,</p>
<p><strong>vote</strong></p>
<ul>
<li>allow incoming connections from anywhere, only on port 80</li>
<li>allow outgoing connections to <strong>redis</strong></li>
<li>block everything else, incoming and outgoing  </li>
</ul>
<p><strong>redis</strong></p>
<ul>
<li>allow incoming connections from <strong>vote</strong> and <strong>worker</strong>, only on port 6379</li>
<li>block everything else, incoming and outgoing  </li>
</ul>
<p><strong>worker</strong></p>
<ul>
<li>allow outgoing connections to <strong>redis</strong> and <strong>db</strong></li>
<li>block everything else, incoming and outgoing  </li>
</ul>
<p><strong>db</strong></p>
<ul>
<li>allow incoming connections from <strong>worker</strong> and <strong>results</strong>, only on port 5342</li>
<li>block everything else, incoming and outgoing  </li>
</ul>
<p><strong>results</strong></p>
<ul>
<li>allow incoming connections from anywhere, only on port 80</li>
<li>allow outgoing connections to <strong>db</strong></li>
<li>block everything else, incoming and outgoing  </li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../ingress/" class="btn btn-neutral float-right" title="Ingress Controllers">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../13_redis_statefulset/" class="btn btn-neutral" title="Creating Replicated Cluster Setup for Redis"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../13_redis_statefulset/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../ingress/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
      <script src="../search/require.js"></script>
      <script src="../search/search.js"></script>

</body>
</html>
